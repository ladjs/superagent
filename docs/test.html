<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">
    <title>SuperAgent â€” elegant API for AJAX in Node and browsers</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/3.0.0/tocbot.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <ul id="menu"></ul>
    <div id="content">
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>res.statusCode</h1>
          <dl>
            <dt>should set statusCode</dt>
            <dd><pre><code>request
.get(uri + '/login', function(err, res){
  try {
  assert.strictEqual(res.statusCode, 200);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>should allow the send shorthand</h1>
          <dl>
            <dt>with callback in the method call</dt>
            <dd><pre><code>request
.get(uri + '/login', function(err, res) {
    assert.equal(res.status, 200);
    done();
});</code></pre></dd>
            <dt>with data in the method call</dt>
            <dd><pre><code>request
.post(uri + '/echo', { foo: 'bar' })
.end(function(err, res) {
  assert.equal('{&quot;foo&quot;:&quot;bar&quot;}', res.text);
  done();
});</code></pre></dd>
            <dt>with callback and data in the method call</dt>
            <dd><pre><code>request
.post(uri + '/echo', { foo: 'bar' }, function(err, res) {
  assert.equal('{&quot;foo&quot;:&quot;bar&quot;}', res.text);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with a callback</h1>
          <dl>
            <dt>should invoke .end()</dt>
            <dd><pre><code>request
.get(uri + '/login', function(err, res){
  try {
  assert.equal(res.status, 200);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.end()</h1>
          <dl>
            <dt>should issue a request</dt>
            <dd><pre><code>request
.get(uri + '/login')
.end(function(err, res){
  try {
  assert.equal(res.status, 200);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>is optional with a promise</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return;
}
return request.get(uri + '/login')
.then(function(res) {
    return res.status;
})
.then()
.then(function(status) {
    assert.equal(200, status, &quot;Real promises pass results through&quot;);
});</code></pre></dd>
            <dt>called only once with a promise</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return;
}
var req = request.get(uri + '/unique');
return Promise.all([req, req, req])
.then(function(results){
  results.forEach(function(item){
    assert.equal(item.body, results[0].body, &quot;It should keep returning the same result after being called once&quot;);
  });
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.error</h1>
          <dl>
            <dt>ok</dt>
            <dd><pre><code>var calledErrorEvent = false;
var calledOKHandler = false;
request
.get(uri + '/error')
.ok(function(res){
  assert.strictEqual(500, res.status);
  calledOKHandler = true;
  return true;
})
.on('error', function(err){
  calledErrorEvent = true;
})
.end(function(err, res){
  try{
    assert.ifError(err);
    assert.strictEqual(res.status, 500);
    assert(!calledErrorEvent);
    assert(calledOKHandler);
    done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should should be an Error object</dt>
            <dd><pre><code>var calledErrorEvent = false;
request
.get(uri + '/error')
.on('error', function(err){
  assert.strictEqual(err.status, 500);
  calledErrorEvent = true;
})
.end(function(err, res){
  try {
  if (NODE) {
    res.error.message.should.equal('cannot GET /error (500)');
  }
  else {
    res.error.message.should.equal('cannot GET ' + uri + '/error (500)');
  }
  assert.strictEqual(res.error.status, 500);
  assert(err, 'should have an error for 500');
  assert.equal(err.message, 'Internal Server Error');
  assert(calledErrorEvent);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>with .then() promise</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return;
}
return request
.get(uri + '/error')
.then(function(){
  assert.fail();
}, function(err){
  assert.equal(err.message, 'Internal Server Error');
});</code></pre></dd>
            <dt>with .ok() returning false</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return;
}
return request
.get(uri + '/echo')
.ok(function() {return false;})
.then(function(){
  assert.fail();
}, function(err){
  assert.equal(200, err.response.status);
  assert.equal(err.message, 'OK');
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.header</h1>
          <dl>
            <dt>should be an object</dt>
            <dd><pre><code>request
.get(uri + '/login')
.end(function(err, res){
  try {
  assert.equal('Express', res.header['x-powered-by']);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>set headers</h1>
          <dl>
            <dt>should only set headers for ownProperties of header</dt>
            <dd><pre><code>try {
  request
    .get(uri + '/echo')
    .end(done);
} catch (e) {
  done(e)
}</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.charset</h1>
          <dl>
            <dt>should be set when present</dt>
            <dd><pre><code>request
.get(uri + '/login')
.end(function(err, res){
  try {
  res.charset.should.equal('utf-8');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.statusType</h1>
          <dl>
            <dt>should provide the first digit</dt>
            <dd><pre><code>request
.get(uri + '/login')
.end(function(err, res){
  try {
  assert(!err, 'should not have an error for success responses');
  assert.equal(200, res.status);
  assert.equal(2, res.statusType);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.type</h1>
          <dl>
            <dt>should provide the mime-type void of params</dt>
            <dd><pre><code>request
.get(uri + '/login')
.end(function(err, res){
  try {
  res.type.should.equal('text/html');
  res.charset.should.equal('utf-8');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.set(field, val)</h1>
          <dl>
            <dt>should set the header field</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.set('X-Foo', 'bar')
.set('X-Bar', 'baz')
.end(function(err, res){
  try {
  assert.equal('bar', res.header['x-foo']);
  assert.equal('baz', res.header['x-bar']);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.set(obj)</h1>
          <dl>
            <dt>should set the header fields</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.set({ 'X-Foo': 'bar', 'X-Bar': 'baz' })
.end(function(err, res){
  try {
  assert.equal('bar', res.header['x-foo']);
  assert.equal('baz', res.header['x-bar']);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.type(str)</h1>
          <dl>
            <dt>should set the Content-Type</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.type('text/x-foo')
.end(function(err, res){
  try {
  res.header['content-type'].should.equal('text/x-foo');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should map &quot;json&quot;</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.type('json')
.send('{&quot;a&quot;: 1}')
.end(function(err, res){
  try {
  res.should.be.json();
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should map &quot;html&quot;</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.type('html')
.end(function(err, res){
  try {
  res.header['content-type'].should.equal('text/html');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.accept(str)</h1>
          <dl>
            <dt>should set Accept</dt>
            <dd><pre><code>request
.get(uri + '/echo')
.accept('text/x-foo')
.end(function(err, res){
  try {
   res.header['accept'].should.equal('text/x-foo');
   done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should map &quot;json&quot;</dt>
            <dd><pre><code>request
.get(uri + '/echo')
.accept('json')
.end(function(err, res){
  try {
  res.header['accept'].should.equal('application/json');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should map &quot;html&quot;</dt>
            <dd><pre><code>request
.get(uri + '/echo')
.accept('html')
.end(function(err, res){
  try {
  res.header['accept'].should.equal('text/html');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.send(str)</h1>
          <dl>
            <dt>should write the string</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.type('json')
.send('{&quot;name&quot;:&quot;tobi&quot;}')
.end(function(err, res){
  try {
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.send(Object)</h1>
          <dl>
            <dt>should default to json</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.end(function(err, res){
  try {
  res.should.be.json();
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <section class="suite">
              <h1>when called several times</h1>
              <dl>
                <dt>should merge the objects</dt>
                <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.send({ age: 1 })
.end(function(err, res){
    try {
  res.should.be.json();
  if (NODE) {
    res.buffered.should.be.true();
  }
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;,&quot;age&quot;:1}');
  done();
  } catch(e) { done(e); }
      });</code></pre></dd>
              </dl>
            </section>
          </dl>
        </section>
        <section class="suite">
          <h1>.end(fn)</h1>
          <dl>
            <dt>should check arity</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.end(function(err, res){
  try {
  assert.equal(null, err);
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should emit request</dt>
            <dd><pre><code>var req = request.post(uri + '/echo');
req.on('request', function(request){
  assert.equal(req, request);
  done();
});
req.end();</code></pre></dd>
            <dt>should emit response</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.on('response', function(res){
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
})
.end();</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.then(fulfill, reject)</h1>
          <dl>
            <dt>should support successful fulfills with .then(fulfill)</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return done();
}
request
.post(uri + '/echo')
.send({ name: 'tobi' })
.then(function(res) {
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
})</code></pre></dd>
            <dt>should reject an error with .then(null, reject)</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return done();
}
request
.get(uri + '/error')
.then(null, function(err) {
  assert.equal(err.status, 500);
  assert.equal(err.response.text, 'boom');
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.catch(reject)</h1>
          <dl>
            <dt>should reject an error with .catch(reject)</dt>
            <dd><pre><code>if ('undefined' === typeof Promise) {
  return done();
}
request
.get(uri + '/error')
.catch(function(err) {
  assert.equal(err.status, 500);
  assert.equal(err.response.text, 'boom');
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.abort()</h1>
          <dl>
            <dt>should abort the request</dt>
            <dd><pre><code>var req = request
.get(uri + '/delay/3000')
.end(function(err, res){
  try {
  assert(false, 'should not complete the request');
  } catch(e) { done(e); }
    });
req.on('error', function(error){
  done(error);
});
req.on('abort', done);
setTimeout(function() {
  req.abort();
}, 500);</code></pre></dd>
            <dt>should allow chaining .abort() several times</dt>
            <dd><pre><code>var req = request
.get(uri + '/delay/3000')
.end(function(err, res){
  try {
  assert(false, 'should not complete the request');
  } catch(e) { done(e); }
});
// This also verifies only a single 'done' event is emitted
req.on('abort', done);
setTimeout(function() {
  req.abort().abort().abort();
}, 1000);</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.toJSON()</h1>
          <dl>
            <dt>should describe the request</dt>
            <dd><pre><code>var req = request
.post(uri + '/echo')
.send({ foo: 'baz' })
.end(function(err, res){
  try {
  var json = req.toJSON();
  assert.equal('POST', json.method);
  assert(/\/echo$/.test(json.url));
  assert.equal('baz', json.data.foo);
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.options()</h1>
          <dl>
            <dt>should allow request body</dt>
            <dd><pre><code>request.options(uri + '/options/echo/body')
.send({ foo: 'baz' })
.end(function(err, res){
  try {
  assert.equal(err, null);
  assert.strictEqual(res.body.foo, 'baz');
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.sortQuery()</h1>
          <dl>
            <dt>nop with no querystring</dt>
            <dd><pre><code>request
.get(uri + '/url')
.sortQuery()
.end(function(err, res){
  try {
  assert.equal(res.text, '/url')
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should sort the request querystring</dt>
            <dd><pre><code>request
.get(uri + '/url')
.query('search=Manny')
.query('order=desc')
.sortQuery()
.end(function(err, res){
  try {
  assert.equal(res.text, '/url?order=desc&amp;search=Manny')
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should allow disabling sorting</dt>
            <dd><pre><code>request
.get(uri + '/url')
.query('search=Manny')
.query('order=desc')
.sortQuery() // take default of true
.sortQuery(false) // override it in later call
.end(function(err, res){
  try {
  assert.equal(res.text, '/url?search=Manny&amp;order=desc')
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
            <dt>should sort the request querystring using customized function</dt>
            <dd><pre><code>request
.get(uri + '/url')
.query('name=Nick')
.query('search=Manny')
.query('order=desc')
.sortQuery(function(a, b){
  return a.length - b.length;
})
.end(function(err, res){
  try {
  assert.equal(res.text, '/url?name=Nick&amp;order=desc&amp;search=Manny')
  done();
  } catch(e) { done(e); }
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>req.set(&quot;Content-Type&quot;, contentType)</h1>
      <dl>
        <dt>should work with just the contentType component</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.set('Content-Type', 'application/json')
.send({ name: 'tobi' })
.end(function(err, res){
  assert(!err);
  done();
});</code></pre></dd>
        <dt>should work with the charset component</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.set('Content-Type', 'application/json; charset=utf-8')
.send({ name: 'tobi' })
.end(function(err, res){
  assert(!err);
  done();
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.send(Object) as &quot;form&quot;</h1>
      <dl>
        <section class="suite">
          <h1>with req.type() set to form</h1>
          <dl>
            <dt>should send x-www-form-urlencoded data</dt>
            <dd><pre><code>request
.post(base + '/echo')
.type('form')
.send({ name: 'tobi' })
.end(function(err, res){
  res.header['content-type'].should.equal('application/x-www-form-urlencoded');
  res.text.should.equal('name=tobi');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>when called several times</h1>
          <dl>
            <dt>should merge the objects</dt>
            <dd><pre><code>request
.post(base + '/echo')
.type('form')
.send({ name: { first: 'tobi', last: 'holowaychuk' } })
.send({ age: '1' })
.end(function(err, res){
  res.header['content-type'].should.equal('application/x-www-form-urlencoded');
  res.text.should.equal('name%5Bfirst%5D=tobi&amp;name%5Blast%5D=holowaychuk&amp;age=1');
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>req.attach</h1>
      <dl>
        <dt>ignores null file</dt>
        <dd><pre><code>request
  .post('/echo')
  .attach('image', null)
  .end(function(err, res){
    done();
  });</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.field</h1>
      <dl>
        <dt>allow bools</dt>
        <dd><pre><code>if (!formDataSupported) {
  return done();
}
request
  .post(base + '/formecho')
  .field('bools', true)
  .field('strings', 'true')
  .end(function(err, res){
    assert.ifError(err);
    assert.deepStrictEqual(res.body, {bools:'true', strings:'true'});
    done();
  });</code></pre></dd>
        <dt>allow objects</dt>
        <dd><pre><code>if (!formDataSupported) {
  return done();
}
request
  .post(base + '/formecho')
  .field({bools: true, strings: 'true'})
  .end(function(err, res){
    assert.ifError(err);
    assert.deepStrictEqual(res.body, {bools:'true', strings:'true'});
    done();
  });</code></pre></dd>
        <dt>works with arrays in objects</dt>
        <dd><pre><code>if (!formDataSupported) {
  return done();
}
request
  .post(base + '/formecho')
  .field({numbers: [1,2,3]})
  .end(function(err, res){
    assert.ifError(err);
    assert.deepStrictEqual(res.body, {numbers:['1','2','3']});
    done();
  });</code></pre></dd>
        <dt>works with arrays</dt>
        <dd><pre><code>if (!formDataSupported) {
  return done();
}
request
  .post(base + '/formecho')
  .field('letters', ['a', 'b', 'c'])
  .end(function(err, res){
    assert.ifError(err);
    assert.deepStrictEqual(res.body, {letters: ['a', 'b', 'c']});
    done();
  });</code></pre></dd>
        <dt>throw when empty</dt>
        <dd><pre><code>should.throws(function(){
  request
  .post(base + '/echo')
  .field()
}, /name/);
should.throws(function(){
  request
  .post(base + '/echo')
  .field('name')
}, /val/);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.send(Object) as &quot;json&quot;</h1>
      <dl>
        <dt>should default to json</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.end(function(err, res){
  res.should.be.json();
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
});</code></pre></dd>
        <dt>should work with arrays</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.send([1,2,3])
.end(function(err, res){
  res.should.be.json();
  res.text.should.equal('[1,2,3]');
  done();
});</code></pre></dd>
        <dt>should work with value null</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.type('json')
.send('null')
.end(function(err, res){
  res.should.be.json();
  assert.strictEqual(res.body, null);
  done();
});</code></pre></dd>
        <dt>should work with value false</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.type('json')
.send('false')
.end(function(err, res){
  res.should.be.json();
  res.body.should.equal(false);
  done();
});</code></pre></dd>
        <dt>should work with value 0</dt>
        <dd><pre><code>// fails in IE9
   request
   .post(uri + '/echo')
   .type('json')
   .send('0')
   .end(function(err, res){
     res.should.be.json();
     res.body.should.equal(0);
     done();
   });</code></pre></dd>
        <dt>should work with empty string value</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.type('json')
.send('&quot;&quot;')
.end(function(err, res){
  res.should.be.json();
  res.body.should.equal(&quot;&quot;);
  done();
});</code></pre></dd>
        <dt>should work with GET</dt>
        <dd><pre><code>request
.get(uri + '/echo')
.send({ tobi: 'ferret' })
.end(function(err, res){
  try {
    res.should.be.json();
    res.text.should.equal('{&quot;tobi&quot;:&quot;ferret&quot;}');
    ({&quot;tobi&quot;:&quot;ferret&quot;}).should.eql(res.body);
    done();
  } catch(e) {done(e);}
});</code></pre></dd>
        <dt>should work with vendor MIME type</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.set('Content-Type', 'application/vnd.example+json')
.send({ name: 'vendor' })
.end(function(err, res){
  res.text.should.equal('{&quot;name&quot;:&quot;vendor&quot;}');
  ({&quot;name&quot;:&quot;vendor&quot;}).should.eql(res.body);
  done();
});</code></pre></dd>
        <section class="suite">
          <h1>when called several times</h1>
          <dl>
            <dt>should merge the objects</dt>
            <dd><pre><code>request
.post(uri + '/echo')
.send({ name: 'tobi' })
.send({ age: 1 })
.end(function(err, res){
  res.should.be.json();
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;,&quot;age&quot;:1}');
  ({&quot;name&quot;:&quot;tobi&quot;,&quot;age&quot;:1}).should.eql(res.body);
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>res.body</h1>
      <dl>
        <section class="suite">
          <h1>application/json</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(uri + '/json')
.end(function(err, res){
  res.text.should.equal('{&quot;name&quot;:&quot;manny&quot;}');
  res.body.should.eql({ name: 'manny' });
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>HEAD requests</h1>
          <dl>
            <dt>should not throw a parse error</dt>
            <dd><pre><code>request
.head(uri + '/json')
.end(function(err, res){
  try {
  assert.strictEqual(err, null);
  assert.strictEqual(res.text, undefined)
  assert.strictEqual(Object.keys(res.body).length, 0)
  done();
  } catch(e) {done(e);}
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>Invalid JSON response</h1>
          <dl>
            <dt>should return the raw response</dt>
            <dd><pre><code>request
.get(uri + '/invalid-json')
.end(function(err, res){
  assert.deepEqual(err.rawResponse, &quot;)]}', {'header':{'code':200,'text':'OK','version':'1.0'},'data':'some data'}&quot;);
  done();
});</code></pre></dd>
            <dt>should return the http status code</dt>
            <dd><pre><code>request
.get(uri + '/invalid-json-forbidden')
.end(function(err, res){
  assert.equal(err.statusCode, 403);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>No content</h1>
          <dl>
            <dt>should not throw a parse error</dt>
            <dd><pre><code>request
.get(uri + '/no-content')
.end(function(err, res){
  try {
  assert.strictEqual(err, null);
  assert.strictEqual(res.text, '');
  assert.strictEqual(Object.keys(res.body).length, 0);
  done();
  } catch(e) {done(e);}
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>application/json+hal</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(uri + '/json-hal')
.end(function(err, res){
  if (err) return done(err);
  res.text.should.equal('{&quot;name&quot;:&quot;hal 5000&quot;}');
  res.body.should.eql({ name: 'hal 5000' });
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>vnd.collection+json</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(uri + '/collection-json')
.end(function(err, res){
  res.text.should.equal('{&quot;name&quot;:&quot;chewbacca&quot;}');
  res.body.should.eql({ name: 'chewbacca' });
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>on redirect</h1>
          <dl>
            <dt>should retain header fields</dt>
            <dd><pre><code>request
.get(base + '/header')
.set('X-Foo', 'bar')
.end(function(err, res){
  try {
    assert(res.body);
    res.body.should.have.property('x-foo', 'bar');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should preserve timeout across redirects</dt>
            <dd><pre><code>request
.get(base + '/movies/random')
.timeout(250)
.end(function(err, res){
  try {
    assert(err instanceof Error, 'expected an error');
    err.should.have.property('timeout', 250);
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should successfully redirect after retry on error</dt>
            <dd><pre><code>var id = Math.random() * 1000000 * Date.now();
request
.get(base + '/error/redirect/' + id)
.retry(2)
.end(function(err, res){
  assert(res.ok, 'response should be ok');
  assert(res.text, 'first movie page');
  done();
});</code></pre></dd>
            <dt>should preserve retries across redirects</dt>
            <dd><pre><code>var id = Math.random() * 1000000 * Date.now();
request
.get(base + '/error/redirect-error' + id)
.retry(2)
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal(2, err.retries, 'expected an error with .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 303</h1>
          <dl>
            <dt>should redirect with same method</dt>
            <dd><pre><code>request
.put(base + '/redirect-303')
.send({msg: &quot;hello&quot;})
.redirects(1)
.on('redirect', function(res) {
  res.headers.location.should.equal('/reply-method')
})
.end(function(err, res){
  if (err) {
    done(err);
    return;
  }
  res.text.should.equal('method=get');
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 307</h1>
          <dl>
            <dt>should redirect with same method</dt>
            <dd><pre><code>if (isMSIE) return done(); // IE9 broken
request
.put(base + '/redirect-307')
.send({msg: &quot;hello&quot;})
.redirects(1)
.on('redirect', function(res) {
  res.headers.location.should.equal('/reply-method')
})
.end(function(err, res){
  if (err) {
    done(err);
    return;
  }
  res.text.should.equal('method=put');
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 308</h1>
          <dl>
            <dt>should redirect with same method</dt>
            <dd><pre><code>if (isMSIE) return done(); // IE9 broken
request
.put(base + '/redirect-308')
.send({msg: &quot;hello&quot;})
.redirects(1)
.on('redirect', function(res) {
  res.headers.location.should.equal('/reply-method')
})
.end(function(err, res){
  if (err) {
    done(err);
    return;
  }
  res.text.should.equal('method=put');
  done();
})</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <dt>Request inheritance</dt>
        <dd><pre><code>assert(request.get(uri + '/') instanceof request.Request);</code></pre></dd>
        <dt>request() simple GET without callback</dt>
        <dd><pre><code>request('GET', 'test/test.request.js').end();
next();</code></pre></dd>
        <dt>request() simple GET</dt>
        <dd><pre><code>request('GET', uri + '/ok').end(function(err, res){
  try {
  assert(res instanceof request.Response, 'respond with Response');
  assert(res.ok, 'response should be ok');
  assert(res.text, 'res.text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() simple HEAD</dt>
        <dd><pre><code>request.head(uri + '/ok').end(function(err, res){
  try {
  assert(res instanceof request.Response, 'respond with Response');
  assert(res.ok, 'response should be ok');
  assert(!res.text, 'res.text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 5xx</dt>
        <dd><pre><code>request('GET', uri + '/error').end(function(err, res){
  try {
  assert(err);
  assert.equal(err.message, 'Internal Server Error');
  assert(!res.ok, 'response should not be ok');
  assert(res.error, 'response should be an error');
  assert(!res.clientError, 'response should not be a client error');
  assert(res.serverError, 'response should be a server error');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 4xx</dt>
        <dd><pre><code>request('GET', uri + '/notfound').end(function(err, res){
  try {
  assert(err);
  assert.equal(err.message, 'Not Found');
  assert(!res.ok, 'response should not be ok');
  assert(res.error, 'response should be an error');
  assert(res.clientError, 'response should be a client error');
  assert(!res.serverError, 'response should not be a server error');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 404 Not Found</dt>
        <dd><pre><code>request('GET', uri + '/notfound').end(function(err, res){
  try {
  assert(err);
  assert(res.notFound, 'response should be .notFound');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 400 Bad Request</dt>
        <dd><pre><code>request('GET', uri + '/bad-request').end(function(err, res){
  try {
  assert(err);
  assert(res.badRequest, 'response should be .badRequest');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 401 Bad Request</dt>
        <dd><pre><code>request('GET', uri + '/unauthorized').end(function(err, res){
  try {
  assert(err);
  assert(res.unauthorized, 'response should be .unauthorized');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 406 Not Acceptable</dt>
        <dd><pre><code>request('GET', uri + '/not-acceptable').end(function(err, res){
  try {
  assert(err);
  assert(res.notAcceptable, 'response should be .notAcceptable');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() GET 204 No Content</dt>
        <dd><pre><code>request('GET', uri + '/no-content').end(function(err, res){
  try {
  assert.ifError(err);
  assert(res.noContent, 'response should be .noContent');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() DELETE 204 No Content</dt>
        <dd><pre><code>request('DELETE', uri + '/no-content').end(function(err, res){
  try {
  assert.ifError(err);
  assert(res.noContent, 'response should be .noContent');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() header parsing</dt>
        <dd><pre><code>request('GET', uri + '/notfound').end(function(err, res){
  try {
  assert(err);
  assert.equal('text/html; charset=utf-8', res.header['content-type']);
  assert.equal('Express', res.header['x-powered-by']);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request() .status</dt>
        <dd><pre><code>request('GET', uri + '/notfound').end(function(err, res){
  try {
  assert(err);
  assert.equal(404, res.status, 'response .status');
  assert.equal(4, res.statusType, 'response .statusType');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>get()</dt>
        <dd><pre><code>request.get( uri + '/notfound').end(function(err, res){
  try {
  assert(err);
  assert.equal(404, res.status, 'response .status');
  assert.equal(4, res.statusType, 'response .statusType');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>put()</dt>
        <dd><pre><code>request.put(uri + '/user/12').end(function(err, res){
  try {
  assert.equal('updated', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>put().send()</dt>
        <dd><pre><code>request.put(uri + '/user/13/body').send({user:&quot;new&quot;}).end(function(err, res){
  try {
  assert.equal('received new', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>post()</dt>
        <dd><pre><code>request.post(uri + '/user').end(function(err, res){
  try {
  assert.equal('created', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>del()</dt>
        <dd><pre><code>request.del(uri + '/user/12').end(function(err, res){
  try {
  assert.equal('deleted', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>delete()</dt>
        <dd><pre><code>request.delete(uri + '/user/12').end(function(err, res){
  try {
  assert.equal('deleted', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>post() data</dt>
        <dd><pre><code>request.post(uri + '/todo/item')
.type('application/octet-stream')
.send('tobi')
.end(function(err, res){
  try {
  assert.equal('added &quot;tobi&quot;', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .type()</dt>
        <dd><pre><code>request
.post(uri + '/user/12/pet')
.type('urlencoded')
.send('pet=tobi')
.end(function(err, res){
  try {
  assert.equal('added pet &quot;tobi&quot;', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .type() with alias</dt>
        <dd><pre><code>request
.post(uri + '/user/12/pet')
.type('application/x-www-form-urlencoded')
.send('pet=tobi')
.end(function(err, res){
  try {
  assert.equal('added pet &quot;tobi&quot;', res.text, 'response text');
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .get() with no data or callback</dt>
        <dd><pre><code>request.get(uri + '/echo-header/content-type');
next();</code></pre></dd>
        <dt>request .send() with no data only</dt>
        <dd><pre><code>request.post(uri + '/user/5/pet').type('urlencoded').send('pet=tobi');
next();</code></pre></dd>
        <dt>request .send() with callback only</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/accept')
.set('Accept', 'foo/bar')
.end(function(err, res){
  try {
  assert.equal('foo/bar', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .accept() with json</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/accept')
.accept('json')
.end(function(err, res){
  try {
  assert.equal('application/json', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .accept() with application/json</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/accept')
.accept('application/json')
.end(function(err, res){
  try {
  assert.equal('application/json', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .accept() with application/xml</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/accept')
.accept('application/xml')
.end(function(err, res){
try {
  assert.equal('application/xml', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .end()</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/content-type')
.set('Content-Type', 'text/plain')
.send('wahoo')
.end(function(err, res){
try {
  assert.equal('text/plain', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .send()</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/content-type')
.set('Content-Type', 'text/plain')
.send('wahoo')
.end(function(err, res){
try {
  assert.equal('text/plain', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .set()</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/content-type')
.set('Content-Type', 'text/plain')
.send('wahoo')
.end(function(err, res){
try {
  assert.equal('text/plain', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request .set(object)</dt>
        <dd><pre><code>request
.get(uri + '/echo-header/content-type')
.set({ 'Content-Type': 'text/plain' })
.send('wahoo')
.end(function(err, res){
try {
  assert.equal('text/plain', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST urlencoded</dt>
        <dd><pre><code>request
.post(uri + '/pet')
.type('urlencoded')
.send({ name: 'Manny', species: 'cat' })
.end(function(err, res){
try {
  assert.equal('added Manny the cat', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST json</dt>
        <dd><pre><code>request
.post(uri + '/pet')
.type('json')
.send({ name: 'Manny', species: 'cat' })
.end(function(err, res){
try {
  assert.equal('added Manny the cat', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST json array</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.send([1,2,3])
.end(function(err, res){
try {
  assert.equal('application/json', res.header['content-type'].split(';')[0]);
  assert.equal('[1,2,3]', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST json default</dt>
        <dd><pre><code>request
.post(uri + '/pet')
.send({ name: 'Manny', species: 'cat' })
.end(function(err, res){
try {
  assert.equal('added Manny the cat', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST json contentType charset</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.set('Content-Type', 'application/json; charset=UTF-8')
.send({ data: ['data1', 'data2'] })
.end(function(err, res){
try {
  assert.equal('{&quot;data&quot;:[&quot;data1&quot;,&quot;data2&quot;]}', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST json contentType vendor</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.set('Content-Type', 'application/vnd.example+json')
.send({ data: ['data1', 'data2'] })
.end(function(err, res){
try {
  assert.equal('{&quot;data&quot;:[&quot;data1&quot;,&quot;data2&quot;]}', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST multiple .send() calls</dt>
        <dd><pre><code>request
.post(uri + '/pet')
.send({ name: 'Manny' })
.send({ species: 'cat' })
.end(function(err, res){
try {
  assert.equal('added Manny the cat', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST multiple .send() strings</dt>
        <dd><pre><code>request
.post(uri + '/echo')
.send('user[name]=tj')
.send('user[email]=tj@vision-media.ca')
.end(function(err, res){
try {
  assert.equal('application/x-www-form-urlencoded', res.header['content-type'].split(';')[0]);
  assert.equal(res.text, 'user[name]=tj&amp;user[email]=tj@vision-media.ca')
  next();
} catch(e) { next(e); }
})</code></pre></dd>
        <dt>POST with no data</dt>
        <dd><pre><code>request
  .post(uri + '/empty-body')
  .send().end(function(err, res){
  try {
    assert.ifError(err);
    assert(res.noContent, 'response should be .noContent');
    next();
  } catch(e) { next(e); }
  });</code></pre></dd>
        <dt>GET .type</dt>
        <dd><pre><code>request
.get(uri + '/pets')
.end(function(err, res){
try {
  assert.equal('application/json', res.type);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET Content-Type params</dt>
        <dd><pre><code>request
.get(uri + '/text')
.end(function(err, res){
  try {
  assert.equal('utf-8', res.charset);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET json</dt>
        <dd><pre><code>request
.get(uri + '/pets')
.end(function(err, res){
  try {
  assert.deepEqual(res.body, ['tobi', 'loki', 'jane']);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET x-www-form-urlencoded</dt>
        <dd><pre><code>request
.get(uri + '/foo')
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { foo: 'bar' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET shorthand</dt>
        <dd><pre><code>request.get(uri + '/foo', function(err, res){
  try {
  assert.equal('foo=bar', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST shorthand</dt>
        <dd><pre><code>request.post(uri + '/user/0/pet', { pet: 'tobi' }, function(err, res){
  try {
  assert.equal('added pet &quot;tobi&quot;', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>POST shorthand without callback</dt>
        <dd><pre><code>request.post(uri + '/user/0/pet', { pet: 'tobi' }).end(function(err, res){
  try {
  assert.equal('added pet &quot;tobi&quot;', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring object with array</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query({ val: ['a', 'b', 'c'] })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { val: ['a', 'b', 'c'] });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring object with array and primitives</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query({ array: ['a', 'b', 'c'], string: 'foo', number: 10 })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { array: ['a', 'b', 'c'], string: 'foo', number: 10 });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring object with two arrays</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query({ array1: ['a', 'b', 'c'], array2: [1, 2, 3]})
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { array1: ['a', 'b', 'c'], array2: [1, 2, 3]});
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring object</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query({ search: 'Manny' })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { search: 'Manny' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring append original</dt>
        <dd><pre><code>request
.get(uri + '/querystring?search=Manny')
.query({ range: '1..5' })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { search: 'Manny', range: '1..5' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring multiple objects</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query({ search: 'Manny' })
.query({ range: '1..5' })
.query({ order: 'desc' })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { search: 'Manny', range: '1..5', order: 'desc' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring with strings</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query('search=Manny')
.query('range=1..5')
.query('order=desc')
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { search: 'Manny', range: '1..5', order: 'desc' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>GET querystring with strings and objects</dt>
        <dd><pre><code>request
.get(uri + '/querystring')
.query('search=Manny')
.query({ order: 'desc', range: '1..5' })
.end(function(err, res){
  try {
  assert.deepEqual(res.body, { search: 'Manny', range: '1..5', order: 'desc' });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request(method, url)</dt>
        <dd><pre><code>request('GET', uri + '/foo').end(function(err, res){
  try {
  assert.equal('bar', res.body.foo);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request(url)</dt>
        <dd><pre><code>request(uri + '/foo').end(function(err, res){
  try {
  assert.equal('bar', res.body.foo);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request(url, fn)</dt>
        <dd><pre><code>request(uri + '/foo', function(err, res){
  try {
  assert.equal('bar', res.body.foo);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>req.timeout(ms)</dt>
        <dd><pre><code>var req = request
.get(uri + '/delay/3000')
.timeout(1000)
.end(function(err, res){
  try {
  assert(err, 'error missing');
  assert.equal(1000, err.timeout, 'err.timeout missing');
  assert.equal('Timeout of 1000ms exceeded', err.message, 'err.message incorrect');
  assert.equal(null, res);
  assert(req.timedout, true);
  next();
} catch(e) { next(e); }
})</code></pre></dd>
        <dt>req.timeout(ms) with redirect</dt>
        <dd><pre><code>var req = request
.get(uri + '/delay/const')
.timeout(1000)
.end(function(err, res) {
  try {
  assert(err, 'error missing');
  assert.equal(1000, err.timeout, 'err.timeout missing');
  assert.equal('Timeout of 1000ms exceeded', err.message, 'err.message incorrect');
  assert.equal(null, res);
  assert(req.timedout, true);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <dt>request event</dt>
        <dd><pre><code>request
.get(uri + '/foo')
.on('request', function(req){
  try {
  assert.equal(uri + '/foo', req.url);
  next();
  } catch(e) { next(e); }
})
.end();</code></pre></dd>
        <dt>response event</dt>
        <dd><pre><code>request
.get(uri + '/foo')
.on('response', function(res){
  try {
  assert.equal('bar', res.body.foo);
  next();
  } catch(e) { next(e); }
})
.end();</code></pre></dd>
        <dt>response should set statusCode</dt>
        <dd><pre><code>request
  .get(uri + '/ok', function(err, res){
    try {
    assert.strictEqual(res.statusCode, 200);
    next();
    } catch(e) { next(e); }
  })</code></pre></dd>
        <dt>req.toJSON()</dt>
        <dd><pre><code>request
.get(uri + '/ok')
.end(function(err, res){
  try {
  var j = (res.request || res.req).toJSON();
  ['url', 'method', 'data', 'headers'].forEach(function(prop){
    assert(j.hasOwnProperty(prop));
  });
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>.retry(count)</h1>
      <dl>
        <dt>should not retry if passed &quot;0&quot;</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry(0)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(undefined, err.retries, 'expected an error without .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should not retry if passed an invalid number</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry(-2)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(undefined, err.retries, 'expected an error without .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should not retry if passed undefined</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry(undefined)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(undefined, err.retries, 'expected an error without .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should handle server error after repeat attempt</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry(2)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(2, err.retries, 'expected an error with .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should retry if passed nothing</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry()
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(1, err.retries, 'expected an error with .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should retry if passed &quot;true&quot;</dt>
        <dd><pre><code>request
.get(base + '/error')
.retry(true)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(1, err.retries, 'expected an error with .retries');
  assert.equal(500, err.status, 'expected an error status of 500');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should handle successful request after repeat attempt from server error</dt>
        <dd><pre><code>request
.get(base + '/error/ok/' + uniqid())
.query({qs:'present'})
.retry(2)
.end(function(err, res){
  try {
  assert.ifError(err);
  assert(res.ok, 'response should be ok');
  assert(res.text, 'res.text');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should handle server timeout error after repeat attempt</dt>
        <dd><pre><code>request
.get(base + '/delay/400')
.timeout(200)
.retry(2)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(2, err.retries, 'expected an error with .retries');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should handle successful request after repeat attempt from server timeout</dt>
        <dd><pre><code>var url = '/delay/400/ok/' + uniqid() + '?built=in';
request
.get(base + url)
.query(&quot;string=ified&quot;)
.query({&quot;json&quot;:&quot;ed&quot;})
.timeout(200)
.retry(2)
.end(function(err, res){
  try {
  assert.ifError(err);
  assert(res.ok, 'response should be ok');
  assert.equal(res.text, 'ok = ' + url + '&amp;string=ified&amp;json=ed');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should correctly abort a retry attempt</dt>
        <dd><pre><code>var aborted = false;
var req = request
.get(base + '/delay/400')
.timeout(200)
.retry(2)
.end(function(err, res){
  try {
    assert(false, 'should not complete the request');
  } catch(e) { done(e); }
});
req.on('abort', function() {
  aborted = true;
});
setTimeout(function() {
  req.abort();
  setTimeout(function() {
    try {
    assert(aborted, 'should be aborted');
    done();
    } catch(err) {
      done(err);
    }
  }, 150)
}, 150);</code></pre></dd>
        <dt>should correctly retain header fields</dt>
        <dd><pre><code>request
.get(base + '/error/ok/' + uniqid())
.query({qs:'present'})
.retry(2)
.set('X-Foo', 'bar')
.end(function(err, res){
  try {
    assert.ifError(err);
    assert(res.body);
    res.body.should.have.property('x-foo', 'bar');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
        <dt>should not retry on 4xx responses</dt>
        <dd><pre><code>request
.get(base + '/bad-request')
.retry(2)
.end(function(err, res){
  try {
  assert(err, 'expected an error');
  assert.equal(0, err.retries, 'expected an error with 0 .retries');
  assert.equal(400, err.status, 'expected an error status of 400');
  done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>.timeout(ms)</h1>
      <dl>
        <section class="suite">
          <h1>when timeout is exceeded</h1>
          <dl>
            <dt>should error</dt>
            <dd><pre><code>request
.get(base + '/delay/500')
.timeout(150)
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  done();
});</code></pre></dd>
            <dt>should handle gzip timeout</dt>
            <dd><pre><code>request
.get(base + '/delay/zip')
.timeout(150)
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  done();
});</code></pre></dd>
            <dt>should handle buffer timeout</dt>
            <dd><pre><code>request
.get(base + '/delay/json')
.buffer(true)
.timeout(150)
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  done();
});</code></pre></dd>
            <dt>should error on deadline</dt>
            <dd><pre><code>request
.get(base + '/delay/500')
.timeout({deadline: 150})
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  done();
});</code></pre></dd>
            <dt>should support setting individual options</dt>
            <dd><pre><code>request
.get(base + '/delay/500')
.timeout({deadline: 10})
.timeout({response: 99999})
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  assert.equal('ETIME', err.errno);
  done();
});</code></pre></dd>
            <dt>should error on response</dt>
            <dd><pre><code>request
.get(base + '/delay/500')
.timeout({response: 150})
.end(function(err, res){
  assert(err, 'expected an error');
  assert.equal('number', typeof err.timeout, 'expected an error with .timeout');
  assert.equal('ECONNABORTED', err.code, 'expected abort error code')
  assert.equal('ETIMEDOUT', err.errno);
  done();
});</code></pre></dd>
            <dt>should accept slow body with fast response</dt>
            <dd><pre><code>request
  .get(base + '/delay/slowbody')
  .timeout({response: 1000})
  .on('progress', function(){
    // This only makes the test faster without relying on arbitrary timeouts
    request.get(base + '/delay/slowbody/finish').end();
  })
  .end(done);</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>use</h1>
          <dl>
            <dt>should use plugin success</dt>
            <dd><pre><code>var now = '' + Date.now();
function uuid(req){
  req.set('X-UUID', now);
  return req;
}
function prefix(req){
  req.url = uri + req.url
  return req;
}
request
  .get('/echo')
  .use(uuid)
  .use(prefix)
  .end(function(err, res){
    assert.strictEqual(res.statusCode, 200);
    assert.equal(res.get('X-UUID'), now);
    done();
  })</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>subclass</h1>
      <dl>
        <dt>should be an instance of Request</dt>
        <dd><pre><code>var req = request.get('/');
assert(req instanceof request.Request);</code></pre></dd>
        <dt>should use patched subclass</dt>
        <dd><pre><code>assert(OriginalRequest);
var constructorCalled, sendCalled;
function NewRequest() {
  constructorCalled = true;
  OriginalRequest.apply(this, arguments);
}
NewRequest.prototype = Object.create(OriginalRequest.prototype);
NewRequest.prototype.send = function() {
  sendCalled = true;
  return this;
};
request.Request = NewRequest;
var req = request.get('/').send();
assert(constructorCalled);
assert(sendCalled);
assert(req instanceof NewRequest);
assert(req instanceof OriginalRequest);</code></pre></dd>
        <dt>should use patched subclass in agent too</dt>
        <dd><pre><code>if (!request.agent) return; // Node-only
function NewRequest() {
  OriginalRequest.apply(this, arguments);
}
NewRequest.prototype = Object.create(OriginalRequest.prototype);
request.Request = NewRequest;
var req = request.agent().del('/');
assert(req instanceof NewRequest);
assert(req instanceof OriginalRequest);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>persistent agent</h1>
          <dl>
            <dt>should gain a session on POST</dt>
            <dd><pre><code>return agent3
  .post(base + '/signin')
  .then(function(res) {
    res.should.have.status(200);
    should.not.exist(res.headers['set-cookie']);
    res.text.should.containEql('dashboard');
  });</code></pre></dd>
            <dt>should start with empty session (set cookies)</dt>
            <dd><pre><code>agent1
  .get(base + '/dashboard')
  .end(function(err, res) {
    should.exist(err);
    res.should.have.status(401);
    should.exist(res.headers['set-cookie']);
    done();
  });</code></pre></dd>
            <dt>should gain a session (cookies already set)</dt>
            <dd><pre><code>return agent1
  .post(base + '/signin')
  .then(function(res) {
    res.should.have.status(200);
    should.not.exist(res.headers['set-cookie']);
    res.text.should.containEql('dashboard');
  });</code></pre></dd>
            <dt>should persist cookies across requests</dt>
            <dd><pre><code>return agent1
  .get(base + '/dashboard')
  .then(function(res) {
    res.should.have.status(200);
  });</code></pre></dd>
            <dt>should have the cookie set in the end callback</dt>
            <dd><pre><code>return agent4
  .post(base + '/setcookie')
  .then(function() {
    return agent4.get(base + '/getcookie')
  })
  .then(function(res) {
    res.should.have.status(200);
    assert.strictEqual(res.text, 'jar');
  });</code></pre></dd>
            <dt>should not share cookies</dt>
            <dd><pre><code>agent2
  .get(base + '/dashboard')
  .end(function(err, res) {
    should.exist(err);
    res.should.have.status(401);
    done();
  });</code></pre></dd>
            <dt>should not lose cookies between agents</dt>
            <dd><pre><code>return agent1
  .get(base + '/dashboard')
  .then(function(res) {
    res.should.have.status(200);
  });</code></pre></dd>
            <dt>should be able to follow redirects</dt>
            <dd><pre><code>return agent1
  .get(base)
  .then(function(res) {
    res.should.have.status(200);
    res.text.should.containEql('dashboard');
  });</code></pre></dd>
            <dt>should be able to post redirects</dt>
            <dd><pre><code>return agent1
  .post(base + '/redirect')
  .send({ foo: 'bar', baz: 'blaaah' })
  .then(function(res) {
    res.should.have.status(200);
    res.text.should.containEql('simple');
    res.redirects.should.eql([base + '/simple']);
  });</code></pre></dd>
            <dt>should be able to limit redirects</dt>
            <dd><pre><code>agent1
  .get(base)
  .redirects(0)
  .end(function(err, res) {
    should.exist(err);
    res.should.have.status(302);
    res.redirects.should.eql([]);
    res.header.location.should.equal('/dashboard');
    done();
  });</code></pre></dd>
            <dt>should be able to create a new session (clear cookie)</dt>
            <dd><pre><code>return agent1
  .post(base + '/signout')
  .then(function(res) {
    res.should.have.status(200);
    should.exist(res.headers['set-cookie']);
  });</code></pre></dd>
            <dt>should regenerate with an empty session</dt>
            <dd><pre><code>agent1
  .get(base + '/dashboard')
  .end(function(err, res) {
    should.exist(err);
    res.should.have.status(401);
    should.not.exist(res.headers['set-cookie']);
    done();
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>Basic auth</h1>
      <dl>
        <section class="suite">
          <h1>when credentials are present in url</h1>
          <dl>
            <dt>should set Authorization</dt>
            <dd><pre><code>var new_url = URL.parse(base);
new_url.auth = 'tobi:learnboost';
new_url.pathname = '/basic-auth';
request
.get(URL.format(new_url))
.end(function(err, res){
  res.status.should.equal(200);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.auth(user, pass)</h1>
          <dl>
            <dt>should set Authorization</dt>
            <dd><pre><code>request
.get(base + '/basic-auth')
.auth('tobi', 'learnboost')
.end(function(err, res){
  res.status.should.equal(200);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.auth(user + &quot;:&quot; + pass)</h1>
          <dl>
            <dt>should set authorization</dt>
            <dd><pre><code>request
.get(base + '/basic-auth/again')
.auth('tobi')
.end(function(err, res){
  res.status.should.eql(200);
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>[node] request</h1>
      <dl>
        <dt>should send body with .get().send()</dt>
        <dd><pre><code>request
.get(base + '/echo')
.set('Content-Type', 'text/plain')
.send('wahoo')
.end(function(err, res){
try {
  assert.equal('wahoo', res.text);
  next();
  } catch(e) { next(e); }
});</code></pre></dd>
        <section class="suite">
          <h1>with an url</h1>
          <dl>
            <dt>should preserve the encoding of the url</dt>
            <dd><pre><code>request
.get(base + '/url?a=(b%29')
.end(function(err, res){
  assert.equal('/url?a=(b%29', res.text);
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with an object</h1>
          <dl>
            <dt>should format the url</dt>
            <dd><pre><code>return request
.get(url.parse(base + '/login'))
.then(function(res){
  assert(res.ok);
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>without a schema</h1>
          <dl>
            <dt>should default to http</dt>
            <dd><pre><code>return request
.get('localhost:5000/login')
.then(function(res){
  assert.equal(res.status, 200);
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.toJSON()</h1>
          <dl>
            <dt>should describe the response</dt>
            <dd><pre><code>return request
.post(base + '/echo')
.send({ foo: 'baz' })
.then(function(res){
  var obj = res.toJSON();
  assert.equal('object', typeof obj.header);
  assert.equal('object', typeof obj.req);
  assert.equal(200, obj.status);
  assert.equal('{&quot;foo&quot;:&quot;baz&quot;}', obj.text);
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>res.links</h1>
          <dl>
            <dt>should default to an empty object</dt>
            <dd><pre><code>return request
.get(base + '/login')
.then(function(res){
  res.links.should.eql({});
})</code></pre></dd>
            <dt>should parse the Link header field</dt>
            <dd><pre><code>request
.get(base + '/links')
.end(function(err, res){
  res.links.next.should.equal('https://api.github.com/repos/visionmedia/mocha/issues?page=2');
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.unset(field)</h1>
          <dl>
            <dt>should remove the header field</dt>
            <dd><pre><code>request
.post(base + '/echo')
.unset('User-Agent')
.end(function(err, res){
  assert.equal(void 0, res.header['user-agent']);
  done();
})</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>case-insensitive</h1>
          <dl>
            <dt>should set/get header fields case-insensitively</dt>
            <dd><pre><code>var r = request.post(base + '/echo');
r.set('MiXeD', 'helloes');
assert.strictEqual(r.get('mixed'), 'helloes');</code></pre></dd>
            <dt>should unset header fields case-insensitively</dt>
            <dd><pre><code>var r = request.post(base + '/echo');
r.set('MiXeD', 'helloes');
r.unset('MIXED');
assert.strictEqual(r.get('mixed'), undefined);</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.write(str)</h1>
          <dl>
            <dt>should write the given data</dt>
            <dd><pre><code>var req = request.post(base + '/echo');
req.set('Content-Type', 'application/json');
assert.equal('boolean', typeof req.write('{&quot;name&quot;'));
assert.equal('boolean', typeof req.write(':&quot;tobi&quot;}'));
req.end(function(err, res){
  res.text.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>req.pipe(stream)</h1>
          <dl>
            <dt>should pipe the response to the given stream</dt>
            <dd><pre><code>var stream = new EventEmitter;
stream.buf = '';
stream.writable = true;
stream.write = function(chunk){
  this.buf += chunk;
};
stream.end = function(){
  this.buf.should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  done();
};
request
.post(base + '/echo')
.send('{&quot;name&quot;:&quot;tobi&quot;}')
.pipe(stream);</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.buffer()</h1>
          <dl>
            <dt>should enable buffering</dt>
            <dd><pre><code>request
.get(base + '/custom')
.buffer()
.end(function(err, res){
  assert.equal(null, err);
  assert.equal('custom stuff', res.text);
  assert(res.buffered);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.buffer(false)</h1>
          <dl>
            <dt>should disable buffering</dt>
            <dd><pre><code>request
.post(base + '/echo')
.type('application/x-dog')
.send('hello this is dog')
.buffer(false)
.end(function(err, res){
  assert.equal(null, err);
  assert.equal(null, res.text);
  res.body.should.eql({});
  var buf = '';
  res.setEncoding('utf8');
  res.on('data', function(chunk){ buf += chunk });
  res.on('end', function(){
    buf.should.equal('hello this is dog');
    done();
  });
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.withCredentials()</h1>
          <dl>
            <dt>should not throw an error when using the client-side &quot;withCredentials&quot; method</dt>
            <dd><pre><code>request
.get(base + '/custom')
.withCredentials()
.end(function(err, res){
  assert.equal(null, err);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.agent()</h1>
          <dl>
            <dt>should return the defaut agent</dt>
            <dd><pre><code>var req = request.post(base + '/echo');
req.agent().should.equal(false);
done();</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.agent(undefined)</h1>
          <dl>
            <dt>should set an agent to undefined and ensure it is chainable</dt>
            <dd><pre><code>var req = request.get(base + '/echo');
var ret = req.agent(undefined);
ret.should.equal(req);
assert.strictEqual(req.agent(), undefined);
done();</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>.agent(new http.Agent())</h1>
          <dl>
            <dt>should set passed agent</dt>
            <dd><pre><code>var http = require('http');
var req = request.get(base + '/echo');
var agent = new http.Agent();
var ret = req.agent(agent);
ret.should.equal(req);
req.agent().should.equal(agent)
done();</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with a content type other than application/json or text/*</h1>
          <dl>
            <dt>should disable buffering</dt>
            <dd><pre><code>request
.post(base + '/echo')
.type('application/x-dog')
.send('hello this is dog')
.end(function(err, res){
  assert.equal(null, err);
  assert.equal(null, res.text);
  res.body.should.eql({});
  var buf = '';
  res.setEncoding('utf8');
  res.buffered.should.be.false;
  res.on('data', function(chunk){ buf += chunk });
  res.on('end', function(){
    buf.should.equal('hello this is dog');
    done();
  });
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>content-length</h1>
          <dl>
            <dt>should be set to the byte length of a non-buffer object</dt>
            <dd><pre><code>var decoder = new StringDecoder('utf8');
var img = fs.readFileSync(__dirname + '/fixtures/test.png');
img = decoder.write(img);
request
.post(base + '/echo')
.type('application/x-image')
.send(img)
.buffer(false)
.end(function(err, res){
  assert.equal(null, err);
  assert(!res.buffered);
  assert.equal(res.header['content-length'], Buffer.byteLength(img));
  done();
});</code></pre></dd>
            <dt>should be set to the length of a buffer object</dt>
            <dd><pre><code>var img = fs.readFileSync(__dirname + '/fixtures/test.png');
request
.post(base + '/echo')
.type('application/x-image')
.send(img)
.buffer(true)
.end(function(err, res){
  assert.equal(null, err);
  assert(res.buffered);
  assert.equal(res.header['content-length'], img.length);
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>exports</h1>
      <dl>
        <dt>should expose .protocols</dt>
        <dd><pre><code>Object.keys(request.protocols)
  .should.eql(['http:', 'https:']);</code></pre></dd>
        <dt>should expose .serialize</dt>
        <dd><pre><code>Object.keys(request.serialize)
  .should.eql(['application/x-www-form-urlencoded', 'application/json']);</code></pre></dd>
        <dt>should expose .parse</dt>
        <dd><pre><code>Object.keys(request.parse)
  .should.eql(['application/x-www-form-urlencoded', 'application/json', 'text', 'application/octet-stream', 'image']);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>flags</h1>
      <dl>
        <section class="suite">
          <h1>with 4xx response</h1>
          <dl>
            <dt>should set res.error and res.clientError</dt>
            <dd><pre><code>request
.get(base + '/notfound')
.end(function(err, res){
  assert(err);
  assert(!res.ok, 'response should not be ok');
  assert(res.error, 'response should be an error');
  assert(res.clientError, 'response should be a client error');
  assert(!res.serverError, 'response should not be a server error');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 5xx response</h1>
          <dl>
            <dt>should set res.error and res.serverError</dt>
            <dd><pre><code>request
.get(base + '/error')
.end(function(err, res){
  assert(err);
  assert(!res.ok, 'response should not be ok');
  assert(!res.notFound, 'response should not be notFound');
  assert(res.error, 'response should be an error');
  assert(!res.clientError, 'response should not be a client error');
  assert(res.serverError, 'response should be a server error');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 404 Not Found</h1>
          <dl>
            <dt>should res.notFound</dt>
            <dd><pre><code>request
.get(base + '/notfound')
.end(function(err, res){
  assert(err);
  assert(res.notFound, 'response should be .notFound');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 400 Bad Request</h1>
          <dl>
            <dt>should set req.badRequest</dt>
            <dd><pre><code>request
.get(base + '/bad-request')
.end(function(err, res){
  assert(err);
  assert(res.badRequest, 'response should be .badRequest');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 401 Bad Request</h1>
          <dl>
            <dt>should set res.unauthorized</dt>
            <dd><pre><code>request
.get(base + '/unauthorized')
.end(function(err, res){
  assert(err);
  assert(res.unauthorized, 'response should be .unauthorized');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 406 Not Acceptable</h1>
          <dl>
            <dt>should set res.notAcceptable</dt>
            <dd><pre><code>request
.get(base + '/not-acceptable')
.end(function(err, res){
  assert(err);
  assert(res.notAcceptable, 'response should be .notAcceptable');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>with 204 No Content</h1>
          <dl>
            <dt>should set res.noContent</dt>
            <dd><pre><code>request
.get(base + '/no-content')
.end(function(err, res){
  assert(!err);
  assert(res.noContent, 'response should be .noContent');
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>Merging objects</h1>
      <dl>
        <dt>Don't mix Buffer and JSON</dt>
        <dd><pre><code>assert.throws(function(){
  request
    .post('/echo')
    .send(new Buffer(&quot;Change this to Buffer.from in April 2017&quot;))
    .send({allowed:false})
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.send(String)</h1>
      <dl>
        <dt>should default to &quot;form&quot;</dt>
        <dd><pre><code>request
.post(base + '/echo')
.send('user[name]=tj')
.send('user[email]=tj@vision-media.ca')
.end(function(err, res){
  res.header['content-type'].should.equal('application/x-www-form-urlencoded');
  res.body.should.eql({ user: { name: 'tj', email: 'tj@vision-media.ca' } });
  done();
})</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>res.body</h1>
      <dl>
        <section class="suite">
          <h1>application/x-www-form-urlencoded</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(base + '/form-data')
.end(function(err, res){
  res.text.should.equal('pet[name]=manny');
  res.body.should.eql({ pet: { name: 'manny' }});
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>https</h1>
      <dl>
        <section class="suite">
          <h1>certificate authority</h1>
          <dl>
            <section class="suite">
              <h1>request</h1>
              <dl>
                <dt>should give a good response</dt>
                <dd><pre><code>request
.get(testEndpoint)
.ca(ca)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  done();
})</code></pre></dd>
              </dl>
            </section>
            <section class="suite">
              <h1>.agent</h1>
              <dl>
                <dt>should be able to make multiple requests without redefining the certificate</dt>
                <dd><pre><code>var agent = request.agent({ca: ca});
agent
.get(testEndpoint)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  agent
  .get(url.parse(testEndpoint))
  .end(function(err, res){
    assert(res.ok);
    assert.strictEqual('Safe and secure!', res.text);
    done();
  })
})</code></pre></dd>
              </dl>
            </section>
          </dl>
        </section>
        <section class="suite">
          <h1>client certificates</h1>
          <dl>
            <section class="suite">
              <h1>request</h1>
              <dl>
                <dt>should give a good response with client certificates and CA</dt>
                <dd><pre><code>request
.get(testEndpoint)
.ca(ca)
.key(key)
.cert(cert)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  done();
})</code></pre></dd>
                <dt>should give a good response with client pfx</dt>
                <dd><pre><code>request
.get(testEndpoint)
.pfx(pfx)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  done();
})</code></pre></dd>
              </dl>
            </section>
            <section class="suite">
              <h1>.agent</h1>
              <dl>
                <dt>should be able to make multiple requests without redefining the certificates</dt>
                <dd><pre><code>var agent = request.agent({ca: ca, key: key, cert: cert});
agent
.get(testEndpoint)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  agent
  .get(url.parse(testEndpoint))
  .end(function(err, res){
    assert(res.ok);
    assert.strictEqual('Safe and secure!', res.text);
    done();
  })
})</code></pre></dd>
                <dt>should be able to make multiple requests without redefining pfx</dt>
                <dd><pre><code>var agent = request.agent({pfx: pfx});
agent
.get(testEndpoint)
.end(function(err, res){
  assert(res.ok);
  assert.strictEqual('Safe and secure!', res.text);
  agent
  .get(url.parse(testEndpoint))
  .end(function(err, res){
    assert(res.ok);
    assert.strictEqual('Safe and secure!', res.text);
    done();
  })
})</code></pre></dd>
              </dl>
            </section>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>res.body</h1>
      <dl>
        <section class="suite">
          <h1>image/png</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(base + '/image')
.end(function(err, res){
  res.type.should.equal('image/png');
  Buffer.isBuffer(res.body).should.be.true();
  (res.body.length - img.length).should.equal(0);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>application/octet-stream</h1>
          <dl>
            <dt>should parse the body</dt>
            <dd><pre><code>request
.get(base + '/image-as-octets')
.buffer(true) // that's tech debt :(
.end(function(err, res){
  res.type.should.equal('application/octet-stream');
  Buffer.isBuffer(res.body).should.be.true();
  (res.body.length - img.length).should.equal(0);
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>application/octet-stream</h1>
          <dl>
            <dt>should parse the body (using responseType)</dt>
            <dd><pre><code>request
    .get(base + '/image-as-octets')
    .responseType('blob')
    .end(function(err, res){
        res.type.should.equal('application/octet-stream');
        Buffer.isBuffer(res.body).should.be.true();
        (res.body.length - img.length).should.equal(0);
        done();
    });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>zlib</h1>
      <dl>
        <dt>should deflate the content</dt>
        <dd><pre><code>request
  .get(base)
  .end(function(err, res) {
    res.should.have.status(200);
    res.text.should.equal(subject);
    res.headers['content-length'].should.be.below(subject.length);
    done();
  });</code></pre></dd>
        <dt>should ignore trailing junk</dt>
        <dd><pre><code>request
  .get(base + '/junk')
  .end(function(err, res) {
    res.should.have.status(200);
    res.text.should.equal(subject);
    done();
  });</code></pre></dd>
        <dt>should ignore missing data</dt>
        <dd><pre><code>request
  .get(base + '/chopped')
  .end(function(err, res) {
    assert.equal(undefined, err);
    res.should.have.status(200);
    res.text.should.startWith(subject);
    done();
  });</code></pre></dd>
        <dt>should handle corrupted responses</dt>
        <dd><pre><code>request
  .get(base + '/corrupt')
  .end(function(err, res) {
    assert(err, 'missing error');
    assert(!res, 'response should not be defined');
    done();
  });</code></pre></dd>
        <dt>should handle no content with gzip header</dt>
        <dd><pre><code>request
  .get(base + '/nocontent')
  .end(function(err, res) {
    assert.ifError(err);
    assert(res);
    res.should.have.status(204);
    res.text.should.equal('');
    res.headers.should.not.have.property('content-length');
    done();
  });</code></pre></dd>
        <section class="suite">
          <h1>without encoding set</h1>
          <dl>
            <dt>should emit buffers</dt>
            <dd><pre><code>request
  .get(base + '/binary')
  .end(function(err, res) {
    res.should.have.status(200);
    res.headers['content-length'].should.be.below(subject.length);
    res.on('data', function(chunk) {
      chunk.should.have.length(subject.length);
    });
    res.on('end', done);
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>Reques</h1>
      <dl>
        <section class="suite">
          <h1>#field(name, value)</h1>
          <dl>
            <dt>should set a multipart field value</dt>
            <dd><pre><code>var req = request.post(base + '/echo');
req.field('user[name]', 'tobi');
req.field('user[age]', '2');
req.field('user[species]', 'ferret');
return req.then(function(res){
  res.body['user[name]'].should.equal('tobi');
  res.body['user[age]'].should.equal('2');
  res.body['user[species]'].should.equal('ferret');
});</code></pre></dd>
            <dt>should work with file attachments</dt>
            <dd><pre><code>var req = request.post(base + '/echo');
req.field('name', 'Tobi');
req.attach('document', 'test/node/fixtures/user.html');
req.field('species', 'ferret');
return req.then(function(res){
  res.body.name.should.equal('Tobi');
  res.body.species.should.equal('ferret');
  var html = res.files.document;
  html.name.should.equal('user.html');
  html.type.should.equal('text/html');
  read(html.path).should.equal('&lt;h1&gt;name&lt;/h1&gt;');
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>#attach(name, path)</h1>
          <dl>
            <dt>should attach a file</dt>
            <dd><pre><code>var req = request.post(base + '/echo');
req.attach('one', 'test/node/fixtures/user.html');
req.attach('two', 'test/node/fixtures/user.json');
req.attach('three', 'test/node/fixtures/user.txt');
return req.then(function(res){
  var html = res.files.one;
  var json = res.files.two
  var text = res.files.three;
  html.name.should.equal('user.html');
  html.type.should.equal('text/html');
  read(html.path).should.equal('&lt;h1&gt;name&lt;/h1&gt;');
  json.name.should.equal('user.json');
  json.type.should.equal('application/json');
  read(json.path).should.equal('{&quot;name&quot;:&quot;tobi&quot;}');
  text.name.should.equal('user.txt');
  text.type.should.equal('text/plain');
  read(text.path).should.equal('Tobi');
});</code></pre></dd>
            <section class="suite">
              <h1>when a file does not exist</h1>
              <dl>
                <dt>should emit an error</dt>
                <dd><pre><code>var req = request.post(base + '/echo');
req.attach('name', 'foo');
req.attach('name2', 'bar');
req.attach('name3', 'baz');
req.on('error', function(err){
  err.message.should.containEql('ENOENT');
  err.path.should.equal('foo');
  done();
});
req.end(function(err, res){
  if (err) return done(err);
  assert(0, 'end() was called');
});</code></pre></dd>
              </dl>
            </section>
          </dl>
        </section>
        <section class="suite">
          <h1>#attach(name, path, filename)</h1>
          <dl>
            <dt>should use the custom filename</dt>
            <dd><pre><code>return request
.post(base + '/echo')
.attach('document', 'test/node/fixtures/user.html', 'doc.html')
.then(function(res){
  var html = res.files.document;
  html.name.should.equal('doc.html');
  html.type.should.equal('text/html');
  read(html.path).should.equal('&lt;h1&gt;name&lt;/h1&gt;');
});</code></pre></dd>
            <dt>should fire progress event</dt>
            <dd><pre><code>var loaded = 0;
var total = 0;
var uploadEventWasFired = false;
request
.post(base + '/echo')
.attach('document', 'test/node/fixtures/user.html')
.on('progress', function (event) {
  total = event.total;
  loaded = event.loaded;
  if (event.direction === 'upload') {
    uploadEventWasFired = true;
  }
})
.end(function(err, res){
  if (err) return done(err);
  var html = res.files.document;
  html.name.should.equal('user.html');
  html.type.should.equal('text/html');
  read(html.path).should.equal('&lt;h1&gt;name&lt;/h1&gt;');
  total.should.equal(223);
  loaded.should.equal(223);
  uploadEventWasFired.should.equal(true);
  done();
})</code></pre></dd>
            <dt>filesystem errors should be caught</dt>
            <dd><pre><code>request
    .post(base + '/echo')
    .attach('filedata', 'test/node/fixtures/non-existent-file.ext')
    .on('error', function(err) {
      err.code.should.equal('ENOENT')
      err.path.should.equal('test/node/fixtures/non-existent-file.ext')
      done()
    })
    .end(function (err, res) {
      done(new Error(&quot;Request should have been aborted earlier!&quot;))
    })</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>#field(name, val)</h1>
          <dl>
            <dt>should set a multipart field value</dt>
            <dd><pre><code>request.post(base + '/echo')
.field('first-name', 'foo')
.field('last-name', 'bar')
.end(function(err, res) {
  if(err) done(err);
  res.should.be.ok();
  res.body['first-name'].should.equal('foo');
  res.body['last-name'].should.equal('bar');
  done();
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>#field(object)</h1>
          <dl>
            <dt>should set multiple multipart fields</dt>
            <dd><pre><code>request.post(base + '/echo')
.field({ 'first-name': 'foo', 'last-name': 'bar' })
.end(function(err, res) {
  if(err) done(err);
  res.should.be.ok();
  res.body['first-name'].should.equal('foo');
  res.body['last-name'].should.equal('bar');
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>with network error</h1>
      <dl>
        <dt>should error</dt>
        <dd><pre><code>request
.get('http://localhost:' + this.port + '/')
.end(function(err, res){
  assert(err, 'expected an error');
  done();
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>not modified</h1>
          <dl>
            <dt>should start with 200</dt>
            <dd><pre><code>request
.get(base + '/if-mod')
.end(function(err, res){
  res.should.have.status(200)
  res.text.should.match(/^\d+$/);
  ts = +res.text;
  done();
});</code></pre></dd>
            <dt>should then be 304</dt>
            <dd><pre><code>request
.get(base + '/if-mod')
.set('If-Modified-Since', new Date(ts).toUTCString())
.end(function(err, res){
  res.should.have.status(304)
  // res.text.should.be.empty
  done();
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>req.parse(fn)</h1>
      <dl>
        <dt>should take precedence over default parsers</dt>
        <dd><pre><code>request
.get(base + '/manny')
.parse(request.parse['application/json'])
.end(function(err, res){
  assert(res.ok);
  assert.equal('{&quot;name&quot;:&quot;manny&quot;}', res.text);
  assert.equal('manny', res.body.name);
  done();
});</code></pre></dd>
        <dt>should be the only parser</dt>
        <dd><pre><code>return request
.get(base + '/image')
.parse(function(res, fn) {
  res.on('data', function() {});
})
.then(function(res){
  assert(res.ok);
  assert.strictEqual(res.text, undefined);
  res.body.should.eql({});
});</code></pre></dd>
        <dt>should emit error if parser throws</dt>
        <dd><pre><code>request
.get(base + '/manny')
.parse(function() {
  throw new Error('I am broken');
})
.on('error', function(err) {
  err.message.should.equal('I am broken');
  done();
})
.end();</code></pre></dd>
        <dt>should emit error if parser returns an error</dt>
        <dd><pre><code>request
.get(base + '/manny')
.parse(function(res, fn) {
  fn(new Error('I am broken'));
})
.on('error', function(err) {
  err.message.should.equal('I am broken');
  done();
})
.end()</code></pre></dd>
        <dt>should not emit error on chunked json</dt>
        <dd><pre><code>request
.get(base + '/chunked-json')
.end(function(err){
  assert(!err);
  done();
});</code></pre></dd>
        <dt>should not emit error on aborted chunked json</dt>
        <dd><pre><code>var req = request
.get(base + '/chunked-json')
.end(function(err){
  assert.ifError(err);
  done();
});
setTimeout(function(){req.abort()},50);</code></pre></dd>
        <dt>should not reject promise on aborted chunked json</dt>
        <dd><pre><code>var req = request.get(base + '/chunked-json')
setTimeout(function(){req.abort()},50);
return req;</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>pipe on redirect</h1>
      <dl>
        <dt>should follow Location</dt>
        <dd><pre><code>var stream = fs.createWriteStream(destPath);
var redirects = [];
var req = request
  .get(base)
  .on('redirect', function (res) {
    redirects.push(res.headers.location);
  })
stream.on('finish', function () {
  redirects.should.eql(['/movies', '/movies/all', '/movies/all/0']);
  fs.readFileSync(destPath, 'utf8').should.eql('first movie page');
  done();
});
req.pipe(stream);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>request pipe</h1>
      <dl>
        <dt>should act as a writable stream</dt>
        <dd><pre><code>var req = request.post(base);
var stream = fs.createReadStream('test/node/fixtures/user.json');
req.type('json');
req.on('response', function(res){
  res.body.should.eql({ name: 'tobi' });
  done();
});
stream.pipe(req);</code></pre></dd>
        <dt>should act as a readable stream</dt>
        <dd><pre><code>var stream = fs.createWriteStream(destPath);
var responseCalled = false;
var req = request.get(base);
req.type('json');
req.on('response', function(res){
  res.should.have.status(200);
  responseCalled = true;
});
stream.on('finish', function(){
  JSON.parse(fs.readFileSync(destPath, 'utf8')).should.eql({ name: 'tobi' });
  responseCalled.should.be.true();
  done();
});
req.pipe(stream);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.query(String)</h1>
      <dl>
        <dt>should support passing in a string</dt>
        <dd><pre><code>request
.del(base)
.query('name=t%F6bi')
.end(function(err, res){
  res.body.should.eql({ name: 't%F6bi' });
  done();
});</code></pre></dd>
        <dt>should work with url query-string and string for query</dt>
        <dd><pre><code>request
.del(base + '/?name=tobi')
.query('age=2%20')
.end(function(err, res){
  res.body.should.eql({ name: 'tobi', age: '2 ' });
  done();
});</code></pre></dd>
        <dt>should support compound elements in a string</dt>
        <dd><pre><code>request
  .del(base)
  .query('name=t%F6bi&amp;age=2')
  .end(function(err, res){
    res.body.should.eql({ name: 't%F6bi', age: '2' });
    done();
  });</code></pre></dd>
        <dt>should work when called multiple times with a string</dt>
        <dd><pre><code>request
.del(base)
.query('name=t%F6bi')
.query('age=2%F6')
.end(function(err, res){
  res.body.should.eql({ name: 't%F6bi', age: '2%F6' });
  done();
});</code></pre></dd>
        <dt>should work with normal `query` object and query string</dt>
        <dd><pre><code>request
.del(base)
.query('name=t%F6bi')
.query({ age: '2' })
.end(function(err, res){
  res.body.should.eql({ name: 't%F6bi', age: '2' });
  done();
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>req.query(Object)</h1>
      <dl>
        <dt>should construct the query-string</dt>
        <dd><pre><code>request
.del(base)
.query({ name: 'tobi' })
.query({ order: 'asc' })
.query({ limit: ['1', '2'] })
.end(function(err, res){
  res.body.should.eql({ name: 'tobi', order: 'asc', limit: ['1', '2'] });
  done();
});</code></pre></dd>
        <dt>should not error on dates</dt>
        <dd><pre><code>var date = new Date(0);
request
.del(base)
.query({ at: date })
.end(function(err, res){
  assert.equal(date.toISOString(), res.body.at);
  done();
});</code></pre></dd>
        <dt>should work after setting header fields</dt>
        <dd><pre><code>request
.del(base)
.set('Foo', 'bar')
.set('Bar', 'baz')
.query({ name: 'tobi' })
.query({ order: 'asc' })
.query({ limit: ['1', '2'] })
.end(function(err, res){
  res.body.should.eql({ name: 'tobi', order: 'asc', limit: ['1', '2'] });
  done();
});</code></pre></dd>
        <dt>should append to the original query-string</dt>
        <dd><pre><code>request
.del(base + '/?name=tobi')
.query({ order: 'asc' })
.end(function(err, res) {
  res.body.should.eql({ name: 'tobi', order: 'asc' });
  done();
});</code></pre></dd>
        <dt>should retain the original query-string</dt>
        <dd><pre><code>request
.del(base + '/?name=tobi')
.end(function(err, res) {
  res.body.should.eql({ name: 'tobi' });
  done();
});</code></pre></dd>
        <dt>should keep only keys with null querystring values</dt>
        <dd><pre><code>request
.del(base + '/url')
.query({ nil: null })
.end(function(err, res) {
  res.text.should.equal('/url?nil');
  done();
});</code></pre></dd>
        <dt>query-string should be sent on pipe</dt>
        <dd><pre><code>var req = request.put(base + '/?name=tobi');
var stream = fs.createReadStream('test/node/fixtures/user.json');
req.on('response', function(res){
  res.body.should.eql({ name: 'tobi' });
  done();
});
stream.pipe(req);</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>request.get</h1>
      <dl>
        <section class="suite">
          <h1>on 301 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .get(base + '/test-301')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port);
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 302 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .get(base + '/test-302')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 303 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .get(base + '/test-303')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 307 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .get(base + '/test-307')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 308 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .get(base + '/test-308')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>request.post</h1>
      <dl>
        <section class="suite">
          <h1>on 301 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .post(base + '/test-301')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 302 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .post(base + '/test-302')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 303 redirect</h1>
          <dl>
            <dt>should follow Location with a GET request</dt>
            <dd><pre><code>var req = request
  .post(base + '/test-303')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('GET');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 307 redirect</h1>
          <dl>
            <dt>should follow Location with a POST request</dt>
            <dd><pre><code>var req = request
  .post(base + '/test-307')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('POST');
    done();
  });</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on 308 redirect</h1>
          <dl>
            <dt>should follow Location with a POST request</dt>
            <dd><pre><code>var req = request
  .post(base + '/test-308')
  .redirects(1)
  .end(function(err, res){
    req.req._headers.host.should.eql('localhost:' + server2.address().port + '');
    res.status.should.eql(200);
    res.text.should.eql('POST');
    done();
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>request</h1>
      <dl>
        <section class="suite">
          <h1>on redirect</h1>
          <dl>
            <dt>should follow Location</dt>
            <dd><pre><code>var redirects = [];
request
.get(base)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    arr.push('/movies');
    arr.push('/movies/all');
    arr.push('/movies/all/0');
    redirects.should.eql(arr);
    res.text.should.equal('first movie page');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should not follow on HEAD by default</dt>
            <dd><pre><code>var redirects = [];
request.head(base)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    redirects.should.eql([]);
    res.status.should.equal(302);
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should follow on HEAD when redirects are set</dt>
            <dd><pre><code>var redirects = [];
request.head(base)
.redirects(10)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    arr.push('/movies');
    arr.push('/movies/all');
    arr.push('/movies/all/0');
    redirects.should.eql(arr);
    assert(!res.text);
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should remove Content-* fields</dt>
            <dd><pre><code>request
.post(base + '/header')
.type('txt')
.set('X-Foo', 'bar')
.set('X-Bar', 'baz')
.send('hey')
.end(function(err, res){
  try {
    assert(res.body);
    res.body.should.have.property('x-foo', 'bar');
    res.body.should.have.property('x-bar', 'baz');
    res.body.should.not.have.property('content-type');
    res.body.should.not.have.property('content-length');
    res.body.should.not.have.property('transfer-encoding');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should retain cookies</dt>
            <dd><pre><code>request
.get(base + '/header')
.set('Cookie', 'foo=bar;')
.end(function(err, res){
  try {
    assert(res.body);
    res.body.should.have.property('cookie', 'foo=bar;');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should not resend query parameters</dt>
            <dd><pre><code>var redirects = [];
var query = [];
request
.get(base + '/?foo=bar')
.on('redirect', function(res){
  query.push(res.headers.query);
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    arr.push('/movies');
    arr.push('/movies/all');
    arr.push('/movies/all/0');
    redirects.should.eql(arr);
    res.text.should.equal('first movie page');
    query.should.eql(['{&quot;foo&quot;:&quot;bar&quot;}', '{}', '{}']);
    res.headers.query.should.eql('{}');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <dt>should handle no location header</dt>
            <dd><pre><code>request
.get(base + '/bad-redirect')
.end(function(err, res){
  try {
    err.message.should.equal('No location header for redirect');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
            <section class="suite">
              <h1>when relative</h1>
              <dl>
                <dt>should redirect to a sibling path</dt>
                <dd><pre><code>var redirects = [];
request
.get(base + '/relative')
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    redirects.should.eql(['tobi']);
    res.text.should.equal('tobi');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
                <dt>should redirect to a parent path</dt>
                <dd><pre><code>var redirects = [];
request
.get(base + '/relative/sub')
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    redirects.should.eql(['../tobi']);
    res.text.should.equal('tobi');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
              </dl>
            </section>
          </dl>
        </section>
        <section class="suite">
          <h1>req.redirects(n)</h1>
          <dl>
            <dt>should alter the default number of redirects to follow</dt>
            <dd><pre><code>var redirects = [];
request
.get(base)
.redirects(2)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    assert(res.redirect, 'res.redirect');
    arr.push('/movies');
    arr.push('/movies/all');
    redirects.should.eql(arr);
    res.text.should.match(/Moved Temporarily|Found/);
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on POST</h1>
          <dl>
            <dt>should redirect as GET</dt>
            <dd><pre><code>var redirects = [];
request
.post(base + '/movie')
.send({ name: 'Tobi' })
.redirects(2)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    arr.push('/movies/all/0');
    redirects.should.eql(arr);
    res.text.should.equal('first movie page');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
          </dl>
        </section>
        <section class="suite">
          <h1>on POST using multipart/form-data</h1>
          <dl>
            <dt>should redirect as GET</dt>
            <dd><pre><code>var redirects = [];
request
.post(base + '/movie')
.type('form')
.field('name', 'Tobi')
.redirects(2)
.on('redirect', function(res){
  redirects.push(res.headers.location);
})
.end(function(err, res){
  try {
    var arr = [];
    arr.push('/movies/all/0');
    redirects.should.eql(arr);
    res.text.should.equal('first movie page');
    done();
  } catch(err) {
    done(err);
  }
});</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>response</h1>
      <dl>
        <dt>should act as a readable stream</dt>
        <dd><pre><code>var req = request
  .get(base)
  .buffer(false);
req.end(function(err,res){
  if (err) return done(err);
  var trackEndEvent = 0;
  var trackCloseEvent = 0;
  res.on('end',function(){
    trackEndEvent++;
    trackEndEvent.should.equal(1);
    trackCloseEvent.should.equal(0);  // close should not have been called
    done();
  });
  res.on('close',function(){
    trackCloseEvent++;
  });

  (function(){ res.pause() }).should.not.throw();
  (function(){ res.resume() }).should.not.throw();
  (function(){ res.destroy() }).should.not.throw();
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>res.toError()</h1>
      <dl>
        <dt>should return an Error</dt>
        <dd><pre><code>request
.get(base)
.end(function(err, res){
  var err = res.toError();
  assert.equal(err.status, 400);
  assert.equal(err.method, 'GET');
  assert.equal(err.path, '/');
  assert.equal(err.message, 'cannot GET / (400)');
  assert.equal(err.text, 'invalid json');
  done();
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>[unix-sockets] http</h1>
      <dl>
        <section class="suite">
          <h1>request</h1>
          <dl>
            <dt>path: / (root)</dt>
            <dd><pre><code>request
  .get(base + '/')
  .end(function(err, res) {
    assert(res.ok);
    assert.strictEqual('root ok!', res.text);
    done();
  });</code></pre></dd>
            <dt>path: /request/path</dt>
            <dd><pre><code>request
  .get(base + '/request/path')
  .end(function(err, res) {
    assert(res.ok);
    assert.strictEqual('request path ok!', res.text);
    done();
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>[unix-sockets] https</h1>
      <dl>
        <section class="suite">
          <h1>request</h1>
          <dl>
            <dt>path: / (root)</dt>
            <dd><pre><code>request
  .get(base + '/')
  .ca(cert)
  .end(function(err, res) {
    assert(res.ok);
    assert.strictEqual('root ok!', res.text);
    done();
  });</code></pre></dd>
            <dt>path: /request/path</dt>
            <dd><pre><code>request
  .get(base + '/request/path')
  .ca(cert)
  .end(function(err, res) {
    assert(res.ok);
    assert.strictEqual('request path ok!', res.text);
    done();
  });</code></pre></dd>
          </dl>
        </section>
      </dl>
    </section>
    <section class="suite">
      <h1>req.get()</h1>
      <dl>
        <dt>should set a default user-agent</dt>
        <dd><pre><code>return request
.get(base + '/ua')
.then(function(res){
  assert(res.headers);
  assert(res.headers['user-agent']);
  assert(/^node-superagent\/\d+\.\d+\.\d+(?:-[a-z]+\.\d+|$)/.test(res.headers['user-agent']));
});</code></pre></dd>
        <dt>should be able to override user-agent</dt>
        <dd><pre><code>return request
.get(base + '/ua')
.set('User-Agent', 'foo/bar')
.then(function(res){
  assert(res.headers);
  assert.equal(res.headers['user-agent'], 'foo/bar');
});</code></pre></dd>
        <dt>should be able to wipe user-agent</dt>
        <dd><pre><code>return request
.get(base + '/ua')
.unset('User-Agent')
.then(function(res){
  assert(res.headers);
  assert.equal(res.headers['user-agent'], void 0);
});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>utils.type(str)</h1>
      <dl>
        <dt>should return the mime type</dt>
        <dd><pre><code>utils.type('application/json; charset=utf-8')
  .should.equal('application/json');
utils.type('application/json')
  .should.equal('application/json');</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>utils.params(str)</h1>
      <dl>
        <dt>should return the field parameters</dt>
        <dd><pre><code>var str = 'application/json; charset=utf-8; foo  = bar';
var obj = utils.params(str);
obj.charset.should.equal('utf-8');
obj.foo.should.equal('bar');
var str = 'application/json';
utils.params(str).should.eql({});</code></pre></dd>
      </dl>
    </section>
    <section class="suite">
      <h1>utils.parseLinks(str)</h1>
      <dl>
        <dt>should parse links</dt>
        <dd><pre><code>var str = '&lt;https://api.github.com/repos/visionmedia/mocha/issues?page=2&gt;; rel=&quot;next&quot;, &lt;https://api.github.com/repos/visionmedia/mocha/issues?page=5&gt;; rel=&quot;last&quot;';
var ret = utils.parseLinks(str);
ret.next.should.equal('https://api.github.com/repos/visionmedia/mocha/issues?page=2');
ret.last.should.equal('https://api.github.com/repos/visionmedia/mocha/issues?page=5');</code></pre></dd>
      </dl>
    </section>
    </div>
    <a href="http://github.com/visionmedia/superagent"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
      $('code').each(function(){
        $(this).html(highlight($(this).text()));
      });

      function highlight(js) {
        return js
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/('.*?')/gm, '<span class="string">$1</span>')
          .replace(/(\d+\.\d+)/gm, '<span class="number">$1</span>')
          .replace(/(\d+)/gm, '<span class="number">$1</span>')
          .replace(/\bnew *(\w+)/gm, '<span class="keyword">new</span> <span class="init">$1</span>')
          .replace(/\b(function|new|throw|return|var|if|else)\b/gm, '<span class="keyword">$1</span>')
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/3.0.0/tocbot.js"></script>
    <script>
      // Only use tocbot for main docs, not test docs
      if (document.querySelector('#superagent')) {
        tocbot.init({
          // Where to render the table of contents.
          tocSelector: '#menu',
          // Where to grab the headings to build the table of contents.
          contentSelector: '#content',
          // Which headings to grab inside of the contentSelector element.
          headingSelector: 'h2',
          smoothScroll: false
        });
      }
    </script>
  </body>
</html>
