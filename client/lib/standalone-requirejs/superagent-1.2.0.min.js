define(function(){function Emitter(obj){if(obj)return mixin(obj)}function mixin(obj){for(var key in Emitter.prototype){obj[key]=Emitter.prototype[key]}return obj}Emitter.prototype.a=Emitter.prototype.b=function(event,fn){this.c=this.c||{};(this.c[event]=this.c[event]||[]).push(fn);return this};Emitter.prototype.d=function(event,fn){var self=this;this.c=this.c||{};function on(){self.e(event,on);fn.apply(this,arguments)}on.f=fn;this.a(event,on);return this};Emitter.prototype.e=Emitter.prototype.g=Emitter.prototype.h=Emitter.prototype.i=function(event,fn){this.c=this.c||{};if(0==arguments.length){this.c={};return this}var callbacks=this.c[event];if(!callbacks)return this;if(1==arguments.length){delete this.c[event];return this}var cb;for(var i=0;i<callbacks.length;i++){cb=callbacks[i];if(cb===fn||cb.f===fn){callbacks.splice(i,1);break}}return this};Emitter.prototype.j=function(event){this.c=this.c||{};var args=[].slice.call(arguments,1),callbacks=this.c[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;i<len;++i){callbacks[i].apply(this,args)}}return this};Emitter.prototype.k=function(event){this.c=this.c||{};return this.c[event]||[]};Emitter.prototype.l=function(event){return!!this.k(event).length};var reduce=function(arr,fn,initial){var idx=0;var len=arr.length;var curr=arguments.length==3?initial:arr[idx++];while(idx<len){curr=fn.call(null,curr,arr[idx],++idx,arr)}return curr};var root="undefined"==typeof window?this||self:window;function noop(){}function isHost(obj){var str={}.toString.call(obj);switch(str){case"[object File]":case"[object Blob]":case"[object FormData]":return true;default:return false}}request.m=function(){if(root.XMLHttpRequest&&(!root.location||"file:"!=root.location.protocol||!root.ActiveXObject)){return new XMLHttpRequest}else{try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e){}}return false};var trim="".trim?function(s){return s.trim()}:function(s){return s.replace(/(^\s*|\s*$)/g,"")};function isObject(obj){return obj===Object(obj)}function serialize(obj){if(!isObject(obj))return obj;var pairs=[];for(var key in obj){if(null!=obj[key]){pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]))}}return pairs.join("&")}request.n=serialize;function parseString(str){var obj={};var pairs=str.split("&");var parts;var pair;for(var i=0,len=pairs.length;i<len;++i){pair=pairs[i];parts=pair.split("=");obj[decodeURIComponent(parts[0])]=decodeURIComponent(parts[1])}return obj}request.o=parseString;request.p={q:"text/html",r:"application/json",s:"application/xml",t:"application/x-www-form-urlencoded",u:"application/x-www-form-urlencoded",v:"application/x-www-form-urlencoded"};request.w={x:serialize,y:JSON.stringify};request.parse={x:parseString,y:JSON.parse};function parseHeader(str){var lines=str.split(/\r?\n/);var fields={};var index;var line;var field;var val;lines.pop();for(var i=0,len=lines.length;i<len;++i){line=lines[i];index=line.indexOf(":");field=line.slice(0,index).toLowerCase();val=trim(line.slice(index+1));fields[field]=val}return fields}function type(str){return str.split(/ *; */).shift()}function params(str){return reduce(str.split(/ *; */),function(obj,str){var parts=str.split(/ *= */),key=parts.shift(),val=parts.shift();if(key&&val)obj[key]=val;return obj},{})}function Response(req,options){options=options||{};this.z=req;this.A=this.z.A;this.B=this.z.C!="HEAD"&&(this.A.responseType===""||this.A.responseType==="text")||typeof this.A.responseType==="undefined"?this.A.responseText:null;this.D=this.z.A.D;this.F(this.A.G);this.H=this.I=parseHeader(this.A.getAllResponseHeaders());this.H["J"]=this.A.getResponseHeader("content-type");this.K(this.H);this.L=this.z.C!="HEAD"?this.M(this.B?this.B:this.A.N):null}Response.prototype.O=function(field){return this.H[field.toLowerCase()]};Response.prototype.K=function(header){var ct=this.H["J"]||"";this.P=type(ct);var obj=params(ct);for(var key in obj)this[key]=obj[key]};Response.prototype.M=function(str){var parse=request.parse[this.P];return parse&&str&&(str.length||str instanceof Object)?parse(str):null};Response.prototype.F=function(status){if(status===1223){status=204}var type=status/100|0;this.G=status;this.Q=type;this.R=1==type;this.S=2==type;this.T=4==type;this.U=5==type;this.V=4==type||5==type?this.W():false;this.X=202==status;this.Y=204==status;this.Z=400==status;this.$=401==status;this._=406==status;this.aa=404==status;this.ba=403==status};Response.prototype.W=function(){var req=this.z;var method=req.C;var url=req.ca;var msg="cannot "+method+" "+url+" ("+this.G+")";var err=new Error(msg);err.G=this.G;err.C=method;err.ca=url;return err};request.da=Response;function Request(method,url){var self=this;Emitter.call(this);this.ea=this.ea||[];this.C=method;this.ca=url;this.H={};this.fa={};this.a("end",function(){var err=null;var res=null;try{res=new Response(self)}catch(e){err=new Error("Parser is unable to parse the response");err.parse=true;err.ga=e;return self.ha(err)}self.j("response",res);if(err){return self.ha(err,res)}if(res.G>=200&&res.G<300){return self.ha(err,res)}var new_err=new Error(res.D||"Unsuccessful HTTP response");new_err.ga=err;new_err.N=res;new_err.G=res.G;self.ha(err||new_err,res)})}Emitter(Request.prototype);Request.prototype.ia=function(fn){fn(this);return this};Request.prototype.ja=function(ms){this.ka=ms;return this};Request.prototype.la=function(){this.ka=0;clearTimeout(this.ma);return this};Request.prototype.na=function(){if(this.oa)return;this.oa=true;this.A.na();this.la();this.j("abort");return this};Request.prototype.pa=function(field,val){if(isObject(field)){for(var key in field){this.pa(key,field[key])}return this}this.fa[field.toLowerCase()]=val;this.H[field]=val;return this};Request.prototype.qa=function(field){delete this.fa[field.toLowerCase()];delete this.H[field];return this};Request.prototype.ra=function(field){return this.fa[field.toLowerCase()]};Request.prototype.P=function(type){this.pa("Content-Type",request.p[type]||type);return this};Request.prototype.sa=function(type){this.pa("Accept",request.p[type]||type);return this};Request.prototype.ta=function(user,pass){var str=btoa(user+":"+pass);this.pa("Authorization","Basic "+str);return this};Request.prototype.ua=function(val){if("string"!=typeof val)val=serialize(val);if(val)this.ea.push(val);return this};Request.prototype.va=function(name,val){if(!this.wa)this.wa=new root.FormData;this.wa.append(name,val);return this};Request.prototype.xa=function(field,file,filename){if(!this.wa)this.wa=new root.FormData;this.wa.append(field,file,filename);return this};Request.prototype.ya=function(data){var obj=isObject(data);var type=this.ra("Content-Type");if(obj&&isObject(this.za)){for(var key in data){this.za[key]=data[key]}}else if("string"==typeof data){if(!type)this.P("form");type=this.ra("Content-Type");if("application/x-www-form-urlencoded"==type){this.za=this.za?this.za+"&"+data:data}else{this.za=(this.za||"")+data}}else{this.za=data}if(!obj||isHost(data))return this;if(!type)this.P("json");return this};Request.prototype.ha=function(err,res){var fn=this.Aa;this.la();fn(err,res)};Request.prototype.Ba=function(){var err=new Error("Origin is not allowed by Access-Control-Allow-Origin");err.Ca=true;this.ha(err)};Request.prototype.Da=function(){var timeout=this.ka;var err=new Error("timeout of "+timeout+"ms exceeded");err.ja=timeout;this.ha(err)};Request.prototype.Ea=function(){this.Fa=true;return this};Request.prototype.Ga=function(fn){var self=this;var xhr=this.A=request.m();var query=this.ea.join("&");var timeout=this.ka;var data=this.wa||this.za;this.Aa=fn||noop;xhr.Ha=function(){if(4!=xhr.readyState)return;var status;try{status=xhr.G}catch(e){status=0}if(0==status){if(self.Ia)return self.Da();if(self.oa)return;return self.Ba()}self.j("end")};var handleProgress=function(e){if(e.total>0){e.Ja=e.loaded/e.total*100}self.j("progress",e)};if(this.l("progress")){xhr.Ka=handleProgress}try{if(xhr.upload&&this.l("progress")){xhr.upload.Ka=handleProgress}}catch(e){}if(timeout&&!this.ma){this.ma=setTimeout(function(){self.Ia=true;self.na()},timeout)}if(query){query=request.n(query);this.ca+=~this.ca.indexOf("?")?"&"+query:"?"+query}xhr.open(this.C,this.ca,true);if(this.Fa)xhr.Ea=true;if("GET"!=this.C&&"HEAD"!=this.C&&"string"!=typeof data&&!isHost(data)){var serialize=request.w[this.ra("Content-Type")];if(serialize)data=serialize(data)}for(var field in this.H){if(null==this.H[field])continue;xhr.setRequestHeader(field,this.H[field])}this.j("request",this);xhr.ya(data);return this};request.La=Request;function request(method,url){if("function"==typeof url){return new Request("GET",method).Ga(url)}if(1==arguments.length){return new Request("GET",method)}return new Request(method,url)}request.O=function(url,data,fn){var req=request("GET",url);if("function"==typeof data)fn=data,data=null;if(data)req.ua(data);if(fn)req.Ga(fn);return req};request.Ma=function(url,data,fn){var req=request("HEAD",url);if("function"==typeof data)fn=data,data=null;if(data)req.ya(data);if(fn)req.Ga(fn);return req};request.Na=function(url,fn){var req=request("DELETE",url);if(fn)req.Ga(fn);return req};request.Oa=function(url,data,fn){var req=request("PATCH",url);if("function"==typeof data)fn=data,data=null;if(data)req.ya(data);if(fn)req.Ga(fn);return req};request.Pa=function(url,data,fn){var req=request("POST",url);if("function"==typeof data)fn=data,data=null;if(data)req.ya(data);if(fn)req.Ga(fn);return req};request.Qa=function(url,data,fn){var req=request("PUT",url);if("function"==typeof data)fn=data,data=null;if(data)req.ya(data);if(fn)req.Ga(fn);return req};return request});